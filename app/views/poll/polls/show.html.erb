<%= javascript_include_tag 'poll' %>

<% content_for :left do %>
  <%= render :partial => '/app_menu' %>
<% end %>

<div>
<%= render :partial => 'poll/menu' %>
</div>

<% if current_user == @user %>
<div>
<%= render :partial => 'menu' %>
</div>
<% end %>

<div style="text-align:center;font-size: 14px;font-weight:bold;padding: 10px">
<%= @poll.name %><span class='poll-tiny'>(最多选<%= @poll.max_multiple %>项)</span><br/>
</div>

<div>
  <% if @poll.past %>
    <%= "该投票已经过期" %>
  <% elsif @poll.subscribers.include? current_user %>
    <%= "你已经投过票了" %>
  <% elsif !votable? @poll, current_user%>
    该投票只对他的好友开放<%= link_to '加他为好友',  :rel => 'facebox' %>
  <% end %>
</div>

<div>
  <div class='part'><label>发起时间: </label><%= ftime @poll.created_at %></div>
  <div class='part'><label>截至时间: </label><span id='end_date'><%= ftime2 @poll.end_date %></span></div>
  <div class='part'><label>投票人数: </label><%= @poll.subscribers.count %></div>
</div>

<% form_tag poll_votes_url(@poll), {:onsubmit => "return validate_multiple_selection()"} do %>
<table>
<% @poll.answers.each do |answer| %>
  <tr class='poll-answer'>
    <td class='description'><%= answer.description %></td>
    <td class='result'><div class='bar'><%= generate_result_bar answer.votes.count, (@poll.votes.count == 0)? 1 : @poll.votes.count %></div></td>
    <td class='select'>
      <% if !@poll.past and !@poll.subscribers.include? current_user and votable? @poll, current_user%> 
        <%= check_box_tag "votes[]", answer.id, false, :onclick => "validate_multiple_selection(#{@poll.max_multiple}, this);"%>
      <% end %>
      (<%= answer.votes.count %>票)
    </td>
  </tr>
<% end %>
  <tr>
    <td></td>
    <td>
      <% if !@poll.past and !@poll.subscribers.include? current_user and votable? @poll, current_user%>
        <%= submit_tag '投票' %>
      <% end %>
    </td>
    <td></td>
  </tr>
</table>
<% end %>

<div class='explanation'>
  <h3>投票选项说明</h3>
  <% if @poll.subscribers.include? current_user %>
  <p id='explanation'>
    <%= @poll.explanation %>
  </p>
  <% else %>
    投票后才能看
  <% end %>
</div>

<div>
  <h3>投票情况</h3>
  <% @poll.subscribers.each do |s| %>
    <% if s == current_user %>
      你选了: <%= @poll.votes_by(s).map { |v| "#{truncate v.poll_answer.description, :lenght => 20, :omission => '...'}" }.join(',') %>
    <% elsif current_user.friends.include? s %>
      你的好友<%= profile_link s%>选了: <%= @poll.votes_by(s).map { |v| "#{truncate v.poll_answer.description, :lenght => 20, :omission => '...'}" }.join(',') %>
    <% end %>
  <% end %>
</div>

<div>
评论(<%= @poll.comments_count %>)
</div>

<div id='comments'>
  <%= render :partial => 'poll/comments/comment', :collection => @comments %>
</div>

<div class='msg-body'>
  <% form_remote_for :comment, :url => poll_comments_url(@poll) do |f| %>
  <div class='composer'>
    <%= hidden_field_tag 'comment[recipient_id]', @user.id%>
    <%= f.text_area 'content', :rows => 5, :cols => 75, :onkeyup => "limit_words_of_text_area(this, 140, $('words_count'));" %>
  </div>
  <div class='button'>
    <%= f.submit '提交', :class => 'confirm-button' %>
    <%= f.label '悄悄话' %><%= f.check_box 'whisper' %>
  </div>
  <% end %>
  <div id='words_count'>0/140</div>
  <div class='emotion'>
    <%= emotion_link "comment_content" %>
  </div>
</div>

